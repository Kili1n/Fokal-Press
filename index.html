<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Presse</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-color: #F5F5F7;
            --card-bg: #FFFFFF;
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --accent: #0071E3;
            --border-color: rgba(0, 0, 0, 0.08);
            --shadow-sm: 0 1px 4px rgba(0, 0, 0, 0.05);
            --radius: 12px;
            --font-main: 'Inter', sans-serif;
            --tag-bg: #F2F2F7;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-primary);
            min-width: 1200px;
            padding-bottom: 60px;
        }

        /* --- NOUVEAU HEADER FIXE --- */
        header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: rgba(245, 245, 247, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 40px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            transition: all 0.3s ease;
        }

        /* Ombre au scroll */
        header.scrolled {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            background: rgba(255, 255, 255, 0.95);
        }

        .header-top, .header-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        /* IDENTIT√â */
        .brand { 
            font-size: 20px; 
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            cursor: pointer; 
            user-select: none; 
            transition: opacity 0.2s;
            min-width: 200px;
        }
        .brand:hover { opacity: 0.7; }
        .brand i { color: var(--accent); }

        /* RECHERCHE ET POS */
        .nav-controls { display: flex; gap: 12px; align-items: center; }

        .search-group { position: relative; display: flex; align-items: center; }
        .search-group i { position: absolute; left: 12px; font-size: 13px; color: var(--text-secondary); }
        
        .location-group { display: flex; gap: 4px; }

        .loc-input {
            padding: 6px 12px; border: 1px solid var(--border-color); border-radius: 8px;
            font-family: var(--font-main); font-size: 13px; color: var(--text-primary);
            background: #FFF; outline: none; height: 36px; transition: border 0.2s;
            width: 160px;
        }
        .search-input { padding-left: 32px !important; width: 220px; }
        .loc-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,113,227,0.1); }

        .icon-btn {
            width: 36px; height: 36px; border: 1px solid var(--border-color); border-radius: 8px;
            background: #FFF; color: var(--text-secondary); cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .icon-btn:hover { color: var(--accent); border-color: var(--accent); }
        .icon-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* FILTRES SECONDAIRES */
        .filter-group { display: flex; align-items: center; gap: 12px; }

        .control-input {
            padding: 0 10px; border: 1px solid var(--border-color); border-radius: 8px;
            font-family: var(--font-main); font-size: 13px; color: var(--text-primary);
            background: #FFF; outline: none; height: 32px; cursor: pointer;
        }

        .filter-label { font-size: 11px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; margin-right: 4px; }

        /* TOGGLE ACCREDITATION */
        .ui-group {
            display: flex; align-items: center; gap: 8px; background: #FFF;
            padding: 0 10px; border-radius: 8px; border: 1px solid var(--border-color); height: 32px;
        }
        
        .switch { position: relative; display: inline-block; width: 30px; height: 16px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .3s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 12px; width: 12px; left: 2px; bottom: 2px;
            background-color: white; transition: .3s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(14px); }

        /* BOUTONS SPORTS */
        .filters { display: flex; gap: 6px; background: #E8E8ED; padding: 3px; border-radius: 10px; }
        .filter-btn { 
            border: none; background: transparent; padding: 6px 16px; 
            font-family: var(--font-main); font-size: 13px; font-weight: 600; 
            color: var(--text-secondary); border-radius: 7px; cursor: pointer; 
            transition: all 0.2s ease; 
        }
        .filter-btn:hover { color: var(--text-primary); }
        .filter-btn.active { background: #FFFFFF; color: var(--text-primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* --- STYLES DES CARTES (INCHANG√âS) --- */
        .container { max-width: 1800px; margin: 30px auto; padding: 0 40px; }
        .matches-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap: 20px; 
        }

        .card { 
            background: var(--card-bg); border-radius: var(--radius); padding: 16px;
            box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); 
            display: flex; flex-direction: column; gap: 12px; transition: transform 0.2s; 
        }
        .card:hover { transform: translateY(-2px); border-color: var(--accent); }

        .match-header { display: flex; justify-content: space-between; align-items: center; }
        .team { display: flex; flex-direction: column; align-items: center; gap: 4px; width: 42%; text-align: center; }
        .team-logo { width: 42px; height: 42px; object-fit: contain; } 
        .team-name { font-weight: 600; font-size: 13px; line-height: 1.1; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; height: 28px; }
        .vs { font-size: 10px; color: var(--text-secondary); font-weight: 700; margin-top: -15px; }

        .match-meta { 
            display: flex; justify-content: space-between; align-items: center; 
            border-top: 1px solid var(--border-color); padding-top: 10px; 
        }
        .badge { 
            padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; 
            text-transform: uppercase; background: var(--tag-bg); color: var(--text-primary); 
            display: flex; align-items: center; gap: 5px;
        }
        .date-time { font-size: 12px; color: var(--text-primary); font-weight: 500; }

        .transport-block { 
            background: #FAFAFA; border-radius: 8px; padding: 8px 10px; 
            display: flex; justify-content: space-between; align-items: center; 
            text-decoration: none; color: inherit; cursor: pointer; transition: background 0.2s;
        }
        .transport-block:hover { background: #F0F0F5; }
        .distance { font-weight: 700; font-size: 12px; }
        .modes { display: flex; gap: 10px; }
        .mode { display: flex; align-items: center; gap: 4px; font-size: 11px; color: var(--text-secondary); }
        .mode i { color: var(--accent); font-size: 10px; }

        .accred-footer { margin-top: auto; padding-top: 10px; border-top: 1px solid var(--border-color); font-size: 11px; display: flex; justify-content: space-between; align-items: center;}
        .accred-status { display: flex; align-items: center; gap: 6px; font-weight: 500; width: 100%; }
        .accred-available { color: #34C759; }
        .accred-unavailable { color: var(--text-secondary); opacity: 0.7; }
        .accred-email { 
            color: var(--text-primary); 
            text-decoration: none; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 250px;
        }
        .accred-email:hover { color: var(--accent); text-decoration: underline; }

        .error-msg { grid-column: 1 / -1; text-align: center; color: #ef4444; background: #fee2e2; padding: 20px; border-radius: 12px; }
    </style>
</head>
<body>

    <header id="mainHeader">
        <div class="header-top">
            <div class="brand" id="siteLogo">
                <i class="fa-solid fa-map-location-dot"></i>
               Dashboard Presse
            </div>

            <div class="nav-controls">
                <div class="search-group">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" id="searchInput" class="loc-input search-input" placeholder="Rechercher un club...">
                </div>

                <div class="location-group">
                    <button class="icon-btn" id="gpsBtn" title="Ma position actuelle"><i class="fa-solid fa-location-crosshairs"></i></button>
                    <input type="text" id="cityInput" class="loc-input" placeholder="Ville...">
                </div>
            </div>
        </div>

        <div class="header-bottom">
            <div class="filters">
                <button class="filter-btn active" data-filter="all">Tous</button>
                <button class="filter-btn" data-filter="football">Foot</button>
                <button class="filter-btn" data-filter="basketball">Basket</button>
                <button class="filter-btn" data-filter="handball">Hand</button>
            </div>

            <div class="filter-group">
                <select id="compFilter" class="control-input">
                    <option value="all">üìä Toutes comp√©titions</option>
                </select>

                <input type="week" id="weekFilter" class="control-input" title="Filtrer par semaine">

                <div class="ui-group">
                    <span class="filter-label">Tri</span>
                    <select id="sortFilter" class="control-input" style="border:none; padding:0; height: auto;">
                        <option value="date">üìÖ Date</option>
                        <option value="distance">üìç Distance</option>
                        <option value="level">üèÜ Niveau</option>
                    </select>
                </div>

                <div class="ui-group">
                    <span class="filter-label">Accr√©d.</span>
                    <label class="switch">
                        <input type="checkbox" id="accredToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="matches-grid" id="grid"></div>
    </div>

    <script src="config.js"></script> 
    <script>
        // --- LOGIQUE D√âTECTION SCROLL POUR HEADER ---
        window.addEventListener('scroll', () => {
            const header = document.getElementById('mainHeader');
            if (window.scrollY > 20) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
        });

        // --- VOTRE LOGIQUE FONCTIONNELLE ORIGINALE (INCHANG√âE) ---
        const GEOAPIFY_KEY = "61ca90447ebd483ab2f002050433fa42"; 
        const LOGO_TOKEN = "pk_ZMm3eD-YScqxE9anYdSV8g";
        const SPORT_EMOJIS = { "football": "‚öΩ", "basketball": "üèÄ", "handball": "ü§æ"};

        const normalize = (str) => {
            if (!str) return '';
            return str.toUpperCase()
                .replace(/[^A-Z0-9]/g, '') 
                .replace(/FC$|SFC$|SC$|FOOTBALL$|JEANNEDARC$|\d+$/g, '');
        };

        const getLogoUrl = (name) => {
            const upperName = name.toUpperCase();
            const customKey = Object.keys(CUSTOM_LOGOS).find(key => upperName.includes(key));
            if (customKey) return CUSTOM_LOGOS[customKey];
            let cleanName = normalize(name);
            return `https://img.logo.dev/name/${encodeURIComponent(cleanName.toLowerCase())}?token=${LOGO_TOKEN}`;
        };

        const formatCompetition = (rawName, sport) => {
            if (!rawName) return "MATCH";
            const name = rawName.toUpperCase();
            const s = (sport).toLowerCase();
            let sportLabel = "HAND";
            if (s.includes("basket")) sportLabel = "BASKET";
            else if (s.includes("foot")) sportLabel = "FOOT";
            else if (s.includes("hand")) sportLabel = "HAND";
            
            let level = "REG", age = "SENIOR";
            if (name.includes("BETCLIC") || name.includes("STARLIGUE")) { level = "L1"; age = "SENIOR"; }
            else if (name.includes("BUTAGAZ") || name.includes("LBWL")) { level = "L1"; age = "SENIOR F"; }
            else if (name.includes("√âLIT2") || name.includes("PROLIGUE")) { level = "L2"; age = "SENIOR"; }
            else if (name.includes("LF2")) { level = "L2"; age = "SENIOR F"; }
            else if (name.includes("NF1")) { level = "N1"; age = "SENIOR F"; }
            else if (name.includes("ESPOIRS")) { level = "L1"; age = "U21"; }
            else if (name.includes("NATIONALE 1")) { level = "N1"; age = "SENIOR"; }
            else {
                const isFeminine = name.includes("F√âMININ") || name.includes("FEMININ") || name.includes(" F ");
                if (name.includes("N3")) level = "N3";
                else if (name.includes("N2")) level = "N2";
                else if (name.includes("D3") && (name.includes("F√âMININE") || name.includes("FEMININE"))) level = "L3";
                else if (name.includes("NATIONAL") || name.includes("NAT")) level = "NAT";
                if (name.includes("U19")) age = "U19";
                else if (name.includes("U17")) age = "U17";
                if (isFeminine && !age.includes("F")) age += " F";
            }
            return `${sportLabel} - ${level} - ${age}`;
        };

        const getAccreditationHTML = (teamName) => {
            const key = Object.keys(ACCRED_LIST).find(k => teamName.toUpperCase().includes(k));
            if (key) {
                const contact = ACCRED_LIST[key];
                const isUrl = contact.startsWith('http');
                const href = isUrl ? contact : `mailto:${contact}`;
                const target = isUrl ? 'target="_blank" rel="noopener noreferrer"' : '';
                return `
                    <div class="accred-status accred-available">
                        <i class="fa-solid fa-check-circle"></i> 
                        <a href="${href}" ${target} class="accred-email">${contact}</a>
                    </div>`;
            }
            return `<div class="accred-status accred-unavailable"><i class="fa-solid fa-circle-xmark"></i> <span>Inconnu</span></div>`;
        };

        const getTeamCoords = (name) => {
            const upperName = name.toUpperCase();
            const key = Object.keys(STADIUM_COORDS).find(k => upperName.includes(k));
            return key ? STADIUM_COORDS[key] : null;
        };

        let allMatches = [];
        let currentFilters = { week: "", comp: "all", sport: "all", accredOnly: false, sortBy: "date", search: "" };
        let userPosition = null;

        async function fetchTravelData(uLat, uLon, dLat, dLon) {
            try {
                const url = `https://api.geoapify.com/v1/routing?waypoints=${uLat},${uLon}|${dLat},${dLon}&mode=drive&apiKey=${GEOAPIFY_KEY}`;
                const res = await fetch(url);
                const data = await res.json();
                if (data.features?.length > 0) {
                    const props = data.features[0].properties;
                    return { dist: Math.round(props.distance / 1000), car: Math.round(props.time / 60) };
                }
            } catch (e) { console.warn(e); }
            return null;
        }

        async function updateDistances() {
            if (!userPosition) return;
            allMatches.forEach(m => m.isCalculating = true);
            applyFilters(); 
            for (let m of allMatches) {
                if (m.locationCoords) {
                    const travel = await fetchTravelData(userPosition.lat, userPosition.lon, m.locationCoords.lat, m.locationCoords.lon);
                    if (travel) {
                        m.distance = travel.dist;
                        m.times.car = travel.car;
                        m.times.public = Math.round(travel.car * 1.5 + 15);
                    }
                }
                m.isCalculating = false;
            }
            applyFilters();
        }

        async function loadMatches() {
            try {
                const response = await fetch('matchs.json');
                const data = await response.json();
                allMatches = data.map(m => ({
                    sport: m.sport,
                    compFormatted: formatCompetition(m.competition, m.sport),
                    home: { name: m.home }, 
                    away: { name: m.away },
                    dateDisplay: m.date,
                    dateObj: new Date(m.isoDate), 
                    locationCoords: getTeamCoords(m.home),
                    distance: 0,
                    times: { car: 0, public: 0 },
                    isCalculating: false
                })).sort((a, b) => a.dateObj - b.dateObj);
                
                applyFilters();
                requestUserLocation();
            } catch (error) {
                document.getElementById('grid').innerHTML = `<div class="error-msg">Erreur de chargement.</div>`;
            }
        }

        function requestUserLocation() {
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    userPosition = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                    document.getElementById('gpsBtn').classList.add('active');
                    document.getElementById('cityInput').value = "Ma position";
                    updateDistances();
                });
            }
        }

        function populateCompFilter(filteredMatches) {
            const select = document.getElementById('compFilter');
            const savedValue = currentFilters.comp;
            select.innerHTML = '<option value="all">üìä Toutes comp√©titions</option>';
            const uniqueComps = [];
            const seen = new Set();
            filteredMatches.forEach(m => {
                if (!seen.has(m.compFormatted)) {
                    seen.add(m.compFormatted);
                    uniqueComps.push({ name: m.compFormatted, sport: m.sport.toLowerCase() });
                }
            });
            uniqueComps.sort((a, b) => a.name.localeCompare(b.name)).forEach(c => {
                const emoji = SPORT_EMOJIS[c.sport] || "üèüÔ∏è";
                const opt = document.createElement('option');
                opt.value = c.name;
                opt.textContent = `${emoji} ${c.name}`;
                if (c.name === savedValue) opt.selected = true;
                select.appendChild(opt);
            });
            if (!seen.has(savedValue)) currentFilters.comp = "all";
        }

        function resetFilters() {
            currentFilters = { week: "", comp: "all", sport: "all", accredOnly: false, sortBy: "date", search: "" };
            document.getElementById('weekFilter').value = "";
            document.getElementById('compFilter').value = "all";
            document.getElementById('sortFilter').value = "date";
            document.getElementById('searchInput').value = "";
            document.getElementById('accredToggle').checked = false;
            document.getElementById('cityInput').value = "";
            document.getElementById('gpsBtn').classList.remove('active');
            userPosition = null;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.filter-btn[data-filter="all"]').classList.add('active');
            applyFilters();
        }

        function applyFilters() {
            let filtered = [...allMatches];

            if (currentFilters.search) {
                const term = currentFilters.search.toLowerCase();
                filtered = filtered.filter(m => 
                    m.home.name.toLowerCase().includes(term) || 
                    m.away.name.toLowerCase().includes(term)
                );
            }

            if (currentFilters.sport !== "all") {
                filtered = filtered.filter(m => m.sport.toLowerCase() === currentFilters.sport);
            }

            populateCompFilter(filtered);

            if (currentFilters.comp !== "all") {
                filtered = filtered.filter(m => m.compFormatted === currentFilters.comp);
            }

            if (currentFilters.accredOnly) {
                const accredKeys = Object.keys(ACCRED_LIST);
                filtered = filtered.filter(m => accredKeys.some(key => m.home.name.toUpperCase().includes(key)));
            }

            if (currentFilters.week) {
                const [y, w] = currentFilters.week.split('-W').map(Number);
                const simple = new Date(y, 0, 1 + (w - 1) * 7);
                const start = new Date(simple.setDate(simple.getDate() - (simple.getDay() || 7) + 1));
                const end = new Date(start); end.setDate(start.getDate() + 6);
                filtered = filtered.filter(m => m.dateObj >= start && m.dateObj <= end);
            }

            filtered.sort((a, b) => {
                if (currentFilters.sortBy === "distance") {
                    if (a.distance === 0 && b.distance === 0) return a.dateObj - b.dateObj;
                    if (a.distance === 0) return 1;
                    if (b.distance === 0) return -1;
                    return a.distance - b.distance;
                } else if (currentFilters.sortBy === "level") {
                    const levels = { 'L1': 1, 'L2': 2, 'NAT': 3, 'N1': 4, 'N2': 5, 'N3': 6, 'REG': 7 };
                    const getRank = (comp) => {
                        const part = comp.split(' - ')[1];
                        return levels[part] || 99;
                    };
                    const rankA = getRank(a.compFormatted);
                    const rankB = getRank(b.compFormatted);
                    return rankA !== rankB ? rankA - rankB : a.dateObj - b.dateObj;
                } else {
                    return a.dateObj - b.dateObj;
                }
            });

            renderMatches(filtered);
        }

        function renderMatches(data) {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            
            if (data.length === 0) {
                grid.innerHTML = `<div class="error-msg" style="background:none; border: 2px dashed #ccc; color: #888;">Aucun match trouv√© pour votre recherche.</div>`;
                return;
            }

            data.forEach(m => {
                const card = document.createElement('article');
                card.className = 'card';
                const emoji = SPORT_EMOJIS[m.sport.toLowerCase()] || "üèüÔ∏è";
                const dist = m.isCalculating ? '<i class="fa-solid fa-spinner fa-spin"></i>' : (m.distance > 0 ? `${m.distance} km` : 'N/A');

                card.innerHTML = `
                    <div class="match-header">
                        <div class="team">
                            <img src="${getLogoUrl(m.home.name)}" class="team-logo" onerror="this.src='https://placehold.co/42x42/png?text=H'">
                            <span class="team-name">${m.home.name}</span>
                        </div>
                        <div class="vs">VS</div>
                        <div class="team">
                            <img src="${getLogoUrl(m.away.name)}" class="team-logo" onerror="this.src='https://placehold.co/42x42/png?text=A'">
                            <span class="team-name">${m.away.name}</span>
                        </div>
                    </div>
                    <div class="match-meta">
                        <span class="badge"><span>${emoji}</span> ${m.compFormatted}</span>
                        <span class="date-time">${m.dateDisplay}</span>
                    </div>
                    <div class="transport-block">
                        <div class="distance">${dist}</div>
                        <div class="modes">
                            <div class="mode"><i class="fa-solid fa-car"></i> ${m.times.car}'</div>
                            <div class="mode"><i class="fa-solid fa-train-subway"></i> ${m.times.public}'</div>
                        </div>
                    </div>
                    <div class="accred-footer">${getAccreditationHTML(m.home.name)}</div>
                `;
                grid.appendChild(card);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadMatches();
            
            document.getElementById('siteLogo').addEventListener('click', resetFilters);

            document.getElementById('searchInput').addEventListener('input', e => {
                currentFilters.search = e.target.value;
                applyFilters();
            });

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelector('.filter-btn.active').classList.remove('active');
                    btn.classList.add('active');
                    currentFilters.sport = btn.dataset.filter;
                    applyFilters();
                });
            });

            document.getElementById('weekFilter').addEventListener('change', e => { currentFilters.week = e.target.value; applyFilters(); });
            document.getElementById('compFilter').addEventListener('change', e => { currentFilters.comp = e.target.value; applyFilters(); });
            document.getElementById('sortFilter').addEventListener('change', e => { currentFilters.sortBy = e.target.value; applyFilters(); });
            document.getElementById('accredToggle').addEventListener('change', e => { currentFilters.accredOnly = e.target.checked; applyFilters(); });
            document.getElementById('gpsBtn').addEventListener('click', requestUserLocation);
        });
    </script>
</body>
</html>
